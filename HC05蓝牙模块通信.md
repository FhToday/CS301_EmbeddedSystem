# HC05 Bluetooth Module Communication

## Group 47

## Design Requirements

### Connection

- Establish a default connection bey KEY0 and KEY1
- Enter the configuration command by serial debugging assistant, establish or close connection, configure the bluetooth model.
- Display the communication status with LED.
- Use serial debugging assistant to send and receive message.
- Detect connection, communication interruption caused by distance,shielded interference or other party shutdown can be prompted.
- Communication connections between different groups.

### UI and Instruction

- The LCD screen displays the chat content and connection status information of the two connected development boards.
- UI design simple and beautiful, reasonable layout, send and receive information left and right alignment, different colors display.
- Serial port output hints for system operation and operation instruction.

## Direction for Use

### Hardware Connection

Connect the Bluetooth module and the development board with the Dupont wire as follows.

| Bluetooth module pin | STM32 Development board pin |
| :------------------: | :-------------------------: |
|         VCC          |            3.3V             |
|         GND          |             GND             |
|         TXD          |             PA3             |
|         RXD          |             PA2             |
|         KEY-         |              -              |
|        STATE         |             PA4             |

Connect the development board to the COMPUTER's USB port with a USB to serial cable.

### Software operation

**Users can input "$"+"instruction" to configure the Bluetooth model.**

Instruction set：

```
$search_devices: Search surrounding devices
$set_role: Set up master or slave
$set_bind_address: Set the default connection address
$set_pswd: Set device's password
$set_name: Set device's name
$link: Pair device with the specified address
$get_addr: Get device's address
$get_name: Get device's name
$get_pswd: Get device's password
```

**Note**: Needs to press the button on the module continuously when sending instructions to the Bluetooth module.

Operation order：

```
$set_role=MASTER
$set_pswd=1234
$set_bind_address=xxxxx
$link
```

After connecting with other device, users can send anything which is shorter than 27 bytes without "$" as front.

## Design Thought

**Decoupling the implementation of connection and GUI.**

<img src="C:\Users\MACHENIKE\Desktop\嵌入式\设计.PNG" alt="设计" style="zoom:67%;" />

**Modular design，using state machine to design.**

<img src="C:\Users\MACHENIKE\Desktop\嵌入式\状态机.PNG" alt="状态机" style="zoom:67%;" />

**For the connection state,  we set a timer, which periodically retrieve the connection status information from the State pin and transmit to uart1 to draw it on the LCD.**

<img src="C:\Users\MACHENIKE\Desktop\嵌入式\image-20201221203050897.png" alt="image-20201221203050897" style="zoom:67%;" />

## System Function Realization

**Model to check connection state.**

<img src="C:\Users\MACHENIKE\Desktop\嵌入式\image-20201220222933429.png" alt="image-20201220222933429" style="zoom:67%;" />

**An example that we translate to AT instruction and transmit to bluetooth after receive an instruction from user.**

<img src="C:\Users\MACHENIKE\Desktop\嵌入式\image-20201220223420834.png" alt="image-20201220223420834" style="zoom:67%;" />

## Problems and solutions in development

1. At first, We thought polling could not achieve communication because we need to to implement the asynchronous by RTOS. After researching interruptions in Lab tutorial,  we found that we can implement it by interruptions.
2. The LCD screen should not be updated too frequently, or some characters may be lost.

## Conclusion

1. Learn about the design and implementation of polling, interruption and RTOS.
2. Learn about basic serial communication method.
3. Feel the process of hardware development and learn the basic design ideas.
4. Improved team cooperation, documentation and other capabilities.

## Work Distribution

**胡轩炜** Implementation of connect, instructions in unconnected state

**杨浩滨** State Control, instructions in unconnected state

**陈琪男** GUI design, report

**王硕** GUI design, report, PPT

## Acknowledgements

Group 16 胡青翘 陈宇恒 李佳霖：  Help us solve the serial priority problem.

Group 1   香佳宏 吴凯跃 张柯远 陈思宇:	Help us solve some GUI problem.

Group 26 许博清 : Help us solve connection problem between phone and bluetooth module.

Group 31  杨佳雨：Help us solve connection problem between  bluetooth modules.